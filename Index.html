<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>BigBackWise</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { height: 100%; }
    body {
      min-height: 100%;
      background: #0f0f1a;
      color: #e8e8f0;
      font-family: 'DM Sans', 'Segoe UI', sans-serif;
      -webkit-text-size-adjust: 100%;
      overflow-x: hidden;
    }
    #root { min-height: 100%; }

    @keyframes spin   { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
    @keyframes pulse  { 0%,100%{opacity:.5} 50%{opacity:.9} }

    .fade-in { animation: fadeIn 0.3s ease; }

    .skeleton {
      background: linear-gradient(90deg,rgba(255,255,255,0.04) 25%,rgba(255,255,255,0.09) 50%,rgba(255,255,255,0.04) 75%);
      background-size: 200% 100%;
      animation: pulse 1.4s ease infinite;
      border-radius: 10px;
    }

    /* ‚îÄ‚îÄ Top header ‚îÄ‚îÄ */
    #top-header {
      position: sticky;
      top: 0;
      z-index: 40;
      background: #0f0f1a;
      border-bottom: 1px solid rgba(255,255,255,0.07);
      padding: 12px 16px 10px;
      padding-top: calc(12px + env(safe-area-inset-top, 0px));
    }

    /* ‚îÄ‚îÄ Bottom nav ‚îÄ‚îÄ */
    #bottom-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 40;
      background: #13131f;
      border-top: 1px solid rgba(255,255,255,0.08);
      display: flex;
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }
    #bottom-nav button {
      flex: 1;
      background: none;
      border: none;
      cursor: pointer;
      padding: 10px 4px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      color: #555;
      transition: color 0.18s;
      position: relative;
      -webkit-tap-highlight-color: transparent;
    }
    #bottom-nav button.active { color: #FF6B6B; }
    #bottom-nav button span.icon { font-size: 20px; line-height: 1; }
    #bottom-nav button span.label { font-size: 10px; font-weight: 600; font-family: 'DM Sans', sans-serif; }
    #bottom-nav .badge {
      position: absolute; top: 7px; left: calc(50% + 7px);
      min-width: 15px; height: 15px; border-radius: 8px;
      background: #FF6B6B; color: #fff;
      font-size: 8px; font-weight: 800;
      display: flex; align-items: center; justify-content: center;
      padding: 0 3px;
    }

    /* ‚îÄ‚îÄ FAB ‚îÄ‚îÄ */
    #fab {
      position: fixed;
      right: 18px;
      bottom: calc(72px + env(safe-area-inset-bottom, 0px));
      z-index: 39;
      width: 54px; height: 54px;
      border-radius: 50%;
      background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
      border: none;
      color: #fff;
      font-size: 28px;
      line-height: 1;
      cursor: pointer;
      box-shadow: 0 4px 18px rgba(255,107,107,0.45);
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.15s, opacity 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    #fab:active { transform: scale(0.93); }
    #fab:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ‚îÄ‚îÄ Content area ‚îÄ‚îÄ */
    #content {
      max-width: 680px;
      margin: 0 auto;
      padding: 14px 16px 100px;
    }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 14px;
      transition: background 0.2s;
    }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn {
      border: none; cursor: pointer; border-radius: 12px;
      font-weight: 600; font-size: 14px; padding: 10px 18px;
      transition: opacity 0.15s, transform 0.15s;
      font-family: inherit;
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active:not(:disabled) { transform: scale(0.97); }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; }
    .btn-primary { background: linear-gradient(135deg,#FF6B6B,#FF8E8E); color:#fff; }
    .btn-ghost   { background: rgba(255,255,255,0.08); color:#ccc; }
    .btn-danger  { background: rgba(255,80,80,0.14); color:#ff6b6b; }

    /* ‚îÄ‚îÄ Inputs ‚îÄ‚îÄ */
    .input {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px; padding: 11px 14px;
      color: #e8e8f0; font-size: 16px; /* 16px prevents iOS zoom */
      font-family: inherit; width: 100%; outline: none;
      transition: border-color 0.18s;
      -webkit-appearance: none;
    }
    .input:focus { border-color: rgba(255,107,107,0.55); }
    select.input option { background: #1a1a2e; }

    /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100;
      display: flex; align-items: flex-end; justify-content: center;
      padding: 0;
    }
    .modal {
      background: #161628;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 22px 22px 0 0;
      padding: 22px 20px;
      padding-bottom: calc(22px + env(safe-area-inset-bottom, 0px));
      width: 100%; max-width: 540px;
      max-height: 92vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* ‚îÄ‚îÄ Misc ‚îÄ‚îÄ */
    .label {
      font-size: 11px; font-weight: 700; color: #777;
      text-transform: uppercase; letter-spacing: 0.07em;
      margin-bottom: 7px; display: block;
    }
    .toggle {
      width: 40px; height: 22px; border-radius: 11px;
      background: rgba(255,255,255,0.1);
      cursor: pointer; position: relative; border: none;
      transition: background 0.2s; flex-shrink: 0;
    }
    .toggle.on { background: linear-gradient(135deg,#4ECDC4,#44B8B0); }
    .toggle-thumb {
      position: absolute; width: 16px; height: 16px;
      border-radius: 50%; background: #fff;
      top: 3px; left: 3px; transition: left 0.2s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      pointer-events: none;
    }
    .toggle.on .toggle-thumb { left: 21px; }
    .serving-badge {
      font-size: 10px; font-weight: 700; padding: 2px 7px;
      border-radius: 10px; background: rgba(255,230,109,0.15); color: #FFE66D;
    }
    .serving-ctrl {
      display: flex; align-items: center;
      background: rgba(255,255,255,0.08); border-radius: 8px; overflow: hidden;
    }
    .serving-btn {
      background: none; border: none; color: #ccc; font-size: 18px;
      width: 34px; height: 34px; cursor: pointer; font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      font-family: inherit;
    }
    .serving-btn:active { background: rgba(255,255,255,0.12); }
    .serving-val { font-size: 14px; font-weight: 700; color: #fff; min-width: 28px; text-align: center; }
    .error-banner {
      margin: 0 0 12px; padding: 10px 14px;
      background: rgba(255,80,80,0.1); border: 1px solid rgba(255,80,80,0.3);
      border-radius: 12px; font-size: 13px; color: #ff8080;
      display: flex; justify-content: space-between; align-items: center;
    }

    .agenda-item {
      display: flex; align-items: flex-start; gap: 12px;
      padding: 13px 14px; border-radius: 13px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
    }
    .agenda-item.discussed {
      background: rgba(78,205,196,0.04);
      border-color: rgba(78,205,196,0.12);
    }
    .agenda-check {
      width: 22px; height: 22px; border-radius: 50%;
      border: 2px solid #444; background: transparent;
      cursor: pointer; flex-shrink: 0; margin-top: 1px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.18s;
    }
    .agenda-check.on { background: #4ECDC4; border-color: #4ECDC4; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const SUPABASE_URL = "https://tqkimzplwikftvkkogih.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxa2ltenBsd2lrZnR2a2tvZ2loIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzQzNjMsImV4cCI6MjA4Njk1MDM2M30.BInx6X4wqrL3ZeytYG9PSsKqGNl7WRCgNn6RPZt90OY";
    const BASE_HDR = {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json",
      Prefer: "return=representation",
    };

    async function sbFetch(path, opts = {}) {
      const { extraHeaders = {}, ...rest } = opts;
      const r = await fetch(`${SUPABASE_URL}/rest/v1${path}`, { headers: { ...BASE_HDR, ...extraHeaders }, ...rest });
      if (!r.ok) throw new Error(`Supabase ${r.status}: ${await r.text()}`);
      const t = await r.text();
      return t ? JSON.parse(t) : null;
    }

    const COLORS = ["#FF6B6B","#4ECDC4","#FFE66D","#A8E6CF","#FF8B94","#B8B8FF"];
    const getColor = (name, friends) => COLORS[Math.max(0, friends.indexOf(name)) % COLORS.length];

    function Avatar({ name, friends, size = 36 }) {
      const c = getColor(name, friends);
      return (
        <div style={{ width:size, height:size, borderRadius:"50%", background:c,
          display:"flex", alignItems:"center", justifyContent:"center",
          fontWeight:700, fontSize:size*0.38, color:"#1a1a2e", flexShrink:0,
          border:"2px solid rgba(255,255,255,0.15)" }}>
          {name[0].toUpperCase()}
        </div>
      );
    }

    function Spinner() {
      return <div style={{ width:18, height:18, border:"2px solid rgba(255,255,255,0.15)",
        borderTopColor:"#FF6B6B", borderRadius:"50%", animation:"spin 0.7s linear infinite", display:"inline-block" }} />;
    }

    function getShare(amount, splits, person) {
      const total = Object.values(splits).reduce((a,b)=>a+b, 0);
      if (!total || !splits[person]) return 0;
      return (splits[person] / total) * amount;
    }

    function computeBalances(expenses, friends) {
      const bal = {};
      friends.forEach(f => bal[f] = 0);
      expenses.forEach(exp => {
        Object.keys(exp.splits).forEach(person => {
          if (person === exp.paid_by) return;
          const share = getShare(exp.amount, exp.splits, person);
          bal[exp.paid_by] = (bal[exp.paid_by]||0) + share;
          bal[person]      = (bal[person]||0) - share;
        });
      });
      return bal;
    }

    function computeRawDebts(expenses) {
      const debts = {};
      expenses.forEach(exp => {
        Object.keys(exp.splits).forEach(person => {
          if (person === exp.paid_by) return;
          const key = `${person}>${exp.paid_by}`;
          debts[key] = (debts[key]||0) + getShare(exp.amount, exp.splits, person);
        });
      });
      const result = [], seen = new Set();
      Object.entries(debts).forEach(([key, amt]) => {
        if (seen.has(key)) return;
        const [from, to] = key.split(">");
        const rev = `${to}>${from}`;
        const net = amt - (debts[rev]||0);
        seen.add(key); seen.add(rev);
        if      (net >  0.01) result.push({ from, to,   amount: net });
        else if (net < -0.01) result.push({ from: to, to: from, amount: -net });
      });
      return result;
    }

    function simplifyDebts(expenses, friends) {
      const bal = computeBalances(expenses, friends);
      const c = Object.entries(bal).filter(([,b])=>b>0.01).map(([name,amount])=>({name,amount})).sort((a,b)=>b.amount-a.amount);
      const d = Object.entries(bal).filter(([,b])=>b<-0.01).map(([name,amount])=>({name,amount:-amount})).sort((a,b)=>b.amount-a.amount);
      const cc=c.map(x=>({...x})), dd=d.map(x=>({...x})), txns=[];
      let i=0, j=0;
      while (i<cc.length && j<dd.length) {
        const amt = Math.min(cc[i].amount, dd[j].amount);
        txns.push({ from:dd[j].name, to:cc[i].name, amount:amt });
        cc[i].amount -= amt; dd[j].amount -= amt;
        if (cc[i].amount < 0.01) i++;
        if (dd[j].amount < 0.01) j++;
      }
      return txns;
    }

    function App() {
      const [friends,     setFriends]     = useState([]);
      const [expenses,    setExpenses]    = useState([]);
      const [agendaItems, setAgendaItems] = useState([]);
      const [tab,         setTab]         = useState("expenses");
      const [simplified,  setSimplified]  = useState(false);
      const [loading,     setLoading]     = useState(true);
      const [saving,      setSaving]      = useState(false);
      const [error,       setError]       = useState(null);
      const [showExpense, setShowExpense] = useState(false);
      const [showFriend,  setShowFriend]  = useState(false);
      const [newFriend,   setNewFriend]   = useState("");
      const [newTopic,    setNewTopic]    = useState("");
      const [addedBy,     setAddedBy]     = useState("");
      const [form, setForm] = useState({ description:"", amount:"", paid_by:"", splits:{} });

      const loadData = useCallback(async () => {
        setLoading(true); setError(null);
        try {
          const [fRows, eRows, sRows, aRows] = await Promise.all([
            sbFetch("/friends?order=created_at.asc&select=name"),
            sbFetch("/expenses?order=created_at.desc&select=id,description,amount,paid_by,date"),
            sbFetch("/expense_splits?select=expense_id,person_name,servings"),
            sbFetch("/agenda_items?order=created_at.asc&select=id,topic,added_by,status,created_at"),
          ]);
          const names = (fRows||[]).map(f=>f.name);
          const sm = {};
          (sRows||[]).forEach(s=>{ if(!sm[s.expense_id]) sm[s.expense_id]={}; sm[s.expense_id][s.person_name]=s.servings; });
          setFriends(names);
          setExpenses((eRows||[]).map(e=>({...e, amount:parseFloat(e.amount), splits:sm[e.id]||{}})));
          setAgendaItems(aRows||[]);
        } catch(e) { setError(e.message); }
        finally { setLoading(false); }
      }, []);

      useEffect(()=>{ loadData(); }, [loadData]);

      async function addFriend() {
        const name = newFriend.trim();
        if (!name || friends.includes(name)) return;
        setSaving(true);
        try {
          await sbFetch("/friends", { method:"POST", body:JSON.stringify({name}) });
          setFriends(p=>[...p, name]);
          setNewFriend(""); setShowFriend(false);
        } catch(e) { setError(e.message); } finally { setSaving(false); }
      }

      async function addExpense() {
        if (!form.description||!form.amount||!form.paid_by||!Object.keys(form.splits).length) return;
        const amt = parseFloat(form.amount);
        if (isNaN(amt)||amt<=0) return;
        setSaving(true);
        try {
          const [row] = await sbFetch("/expenses", { method:"POST", body:JSON.stringify({ description:form.description, amount:amt, paid_by:form.paid_by, date:new Date().toISOString().split("T")[0] }) });
          await sbFetch("/expense_splits", { method:"POST", body:JSON.stringify(Object.entries(form.splits).map(([person_name,servings])=>({ expense_id:row.id, person_name, servings }))) });
          setExpenses(p=>[{...row, amount:parseFloat(row.amount), splits:{...form.splits}}, ...p]);
          setForm({description:"", amount:"", paid_by:"", splits:{}});
          setShowExpense(false);
        } catch(e) { setError(e.message); } finally { setSaving(false); }
      }

      async function deleteExpense(id) {
        setSaving(true);
        try {
          await sbFetch(`/expenses?id=eq.${id}`, { method:"DELETE", extraHeaders:{Prefer:""} });
          setExpenses(p=>p.filter(e=>e.id!==id));
        } catch(e) { setError(e.message); } finally { setSaving(false); }
      }

      async function addAgendaItem() {
        const topic = newTopic.trim();
        if (!topic) return;
        setSaving(true);
        try {
          const body = { topic, status:"pending" };
          if (addedBy.trim()) body.added_by = addedBy.trim();
          const [row] = await sbFetch("/agenda_items", { method:"POST", body:JSON.stringify(body) });
          setAgendaItems(p=>[...p, row]);
          setNewTopic(""); setAddedBy("");
        } catch(e) { setError(e.message); } finally { setSaving(false); }
      }

      async function toggleAgenda(item) {
        const status = item.status==="pending" ? "discussed" : "pending";
        setSaving(true);
        try {
          await sbFetch(`/agenda_items?id=eq.${item.id}`, { method:"PATCH", body:JSON.stringify({status}) });
          setAgendaItems(p=>p.map(a=>a.id===item.id ? {...a,status} : a));
        } catch(e) { setError(e.message); } finally { setSaving(false); }
      }

      async function deleteAgendaItem(id) {
        setSaving(true);
        try {
          await sbFetch(`/agenda_items?id=eq.${id}`, { method:"DELETE", extraHeaders:{Prefer:""} });
          setAgendaItems(p=>p.filter(a=>a.id!==id));
        } catch(e) { setError(e.message); } finally { setSaving(false); }
      }

      function togglePerson(name) {
        setForm(prev => {
          if (name === prev.paid_by) return prev;
          const splits = {...prev.splits};
          if (splits[name]!==undefined) delete splits[name]; else splits[name]=2;
          return {...prev, splits};
        });
      }
      function setServings(name, val) {
        const v = Math.max(1, Math.min(99, val));
        setForm(p=>({...p, splits:{...p.splits, [name]:v}}));
      }

      const balances   = computeBalances(expenses, friends);
      const rawDebts   = computeRawDebts(expenses);
      const simpDebts  = simplifyDebts(expenses, friends);
      const settle     = simplified ? simpDebts : rawDebts;
      const totalExp   = expenses.reduce((s,e)=>s+e.amount, 0);
      const totalSrv   = Object.values(form.splits).reduce((a,b)=>a+b, 0);
      const formAmt    = parseFloat(form.amount)||0;
      const pending    = agendaItems.filter(a=>a.status==="pending").length;

      const TABS = [
        {id:"expenses", icon:"üí≥", label:"Expenses"},
        {id:"balances", icon:"‚öñÔ∏è",  label:"Balances"},
        {id:"settle",   icon:"ü§ù",  label:"Settle"},
        {id:"agenda",   icon:"üìã",  label:"Agenda"},
      ];

      return (
        <>
          {/* ‚îÄ‚îÄ Top header ‚îÄ‚îÄ */}
          <div id="top-header">
            <div style={{ maxWidth:680, margin:"0 auto" }}>
              <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:10 }}>
                <div style={{ display:"flex", alignItems:"center", gap:8 }}>
                  <h1 style={{ fontFamily:"'Syne',sans-serif", fontSize:22, fontWeight:800, color:"#fff", letterSpacing:"-0.4px" }}>
                    BigBack<span style={{ color:"#FF6B6B" }}>Wise</span>
                  </h1>
                  {saving && <Spinner />}
                </div>
                <div style={{ display:"flex", alignItems:"center", gap:8 }}>
                  {!loading && <span style={{ fontSize:12, color:"#555" }}>${totalExp.toFixed(0)} total</span>}
                </div>
              </div>

              {/* Avatar strip */}
              {loading
                ? <div style={{ display:"flex", gap:12 }}>{[1,2,3].map(i=><div key={i} className="skeleton" style={{ width:32, height:32, borderRadius:"50%", flexShrink:0 }}/>)}</div>
                : <div style={{ display:"flex", gap:14, overflowX:"auto", paddingBottom:2, WebkitOverflowScrolling:"touch" }}
                    className="hide-scroll">
                    {friends.map(f=>{
                      const bal = balances[f]||0;
                      return (
                        <div key={f} style={{ display:"flex", flexDirection:"column", alignItems:"center", gap:2, flexShrink:0 }}>
                          <Avatar name={f} friends={friends} size={32}/>
                          <span style={{ fontSize:10, color:"#666" }}>{f}</span>
                          {(bal>0.01||bal<-0.01) && (
                            <span style={{ fontSize:10, fontWeight:700, color:bal>0.01?"#4ECDC4":"#FF6B6B" }}>
                              {bal>0.01?`+$${bal.toFixed(0)}`:`-$${Math.abs(bal).toFixed(0)}`}
                            </span>
                          )}
                        </div>
                      );
                    })}
                  </div>
              }
            </div>
          </div>

          {/* ‚îÄ‚îÄ Content ‚îÄ‚îÄ */}
          <div id="content">
            {error && (
              <div className="error-banner">
                <span>‚ö† {error}</span>
                <button onClick={()=>setError(null)} style={{ background:"none", border:"none", color:"#ff8080", cursor:"pointer", fontSize:16 }}>‚úï</button>
              </div>
            )}

            <div className="fade-in" key={tab}>

              {/* EXPENSES */}
              {tab==="expenses" && (
                <div style={{ display:"flex", flexDirection:"column", gap:10 }}>
                  {loading && [1,2,3].map(i=><div key={i} className="skeleton" style={{ height:100, borderRadius:14 }}/>)}
                  {!loading && expenses.length===0 && (
                    <div style={{ textAlign:"center", color:"#555", padding:"60px 0" }}>
                      <div style={{ fontSize:36, marginBottom:10 }}>üçΩ</div>
                      <div style={{ fontWeight:600, color:"#666" }}>No expenses yet</div>
                      <div style={{ fontSize:13, color:"#444", marginTop:4 }}>Tap + to add one</div>
                    </div>
                  )}
                  {expenses.map(exp=>{
                    const people = Object.keys(exp.splits);
                    const totSrv = Object.values(exp.splits).reduce((a,b)=>a+b,0);
                    const custom = !people.every(p=>exp.splits[p]===1);
                    return (
                      <div key={exp.id} className="card">
                        <div style={{ display:"flex", alignItems:"flex-start", gap:12 }}>
                          <div style={{ width:40, height:40, borderRadius:10, background:"rgba(255,107,107,0.12)", display:"flex", alignItems:"center", justifyContent:"center", fontSize:18, flexShrink:0 }}>üí≥</div>
                          <div style={{ flex:1, minWidth:0 }}>
                            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"flex-start", gap:8 }}>
                              <div style={{ display:"flex", alignItems:"center", gap:6, flexWrap:"wrap" }}>
                                <span style={{ fontWeight:700, fontSize:15, color:"#fff" }}>{exp.description}</span>
                                {custom && <span className="serving-badge">‚öñ custom</span>}
                              </div>
                              <span style={{ fontWeight:800, fontSize:17, color:"#fff", flexShrink:0 }}>${exp.amount.toFixed(2)}</span>
                            </div>
                            <div style={{ marginTop:4, display:"flex", alignItems:"center", gap:6, flexWrap:"wrap" }}>
                              <span style={{ fontSize:12, color:"#888" }}>Paid by</span>
                              <Avatar name={exp.paid_by} friends={friends} size={16}/>
                              <span style={{ fontSize:12, color:"#bbb", fontWeight:600 }}>{exp.paid_by}</span>
                              <span style={{ fontSize:12, color:"#555" }}>¬∑ {exp.date}</span>
                            </div>
                            <div style={{ marginTop:8, display:"flex", flexDirection:"column", gap:4 }}>
                              {people.map(p=>{
                                const share = getShare(exp.amount, exp.splits, p);
                                const pct   = (exp.splits[p]/totSrv)*100;
                                const col   = getColor(p, friends);
                                return (
                                  <div key={p} style={{ display:"flex", alignItems:"center", gap:8 }}>
                                    <Avatar name={p} friends={friends} size={18}/>
                                    <span style={{ fontSize:12, color:"#bbb", minWidth:44 }}>{p}</span>
                                    <div style={{ flex:1, height:4, background:"rgba(255,255,255,0.05)", borderRadius:2, overflow:"hidden" }}>
                                      <div style={{ height:"100%", width:`${pct}%`, background:col, borderRadius:2 }}/>
                                    </div>
                                    <span style={{ fontSize:12, fontWeight:700, color:"#fff", minWidth:50, textAlign:"right" }}>${share.toFixed(2)}</span>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                          <button className="btn btn-danger" style={{ padding:"5px 9px", fontSize:13, flexShrink:0 }}
                            onClick={()=>deleteExpense(exp.id)} disabled={saving}>‚úï</button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}

              {/* BALANCES */}
              {tab==="balances" && (
                <div style={{ display:"flex", flexDirection:"column", gap:10 }}>
                  {loading && [1,2,3].map(i=><div key={i} className="skeleton" style={{ height:80, borderRadius:14 }}/>)}
                  {!loading && friends.map(f=>{
                    const bal = balances[f]||0;
                    const pos = bal>0.01, neg = bal<-0.01;
                    const pct = totalExp>0 ? Math.min(100, Math.abs(bal)/(totalExp/Math.max(1,friends.length))*50) : 0;
                    return (
                      <div key={f} className="card">
                        <div style={{ display:"flex", alignItems:"center", gap:12 }}>
                          <Avatar name={f} friends={friends} size={40}/>
                          <div style={{ flex:1 }}>
                            <div style={{ display:"flex", justifyContent:"space-between" }}>
                              <span style={{ fontWeight:700, color:"#fff" }}>{f}</span>
                              <span style={{ fontWeight:800, fontSize:16, color:pos?"#4ECDC4":neg?"#FF6B6B":"#555" }}>
                                {pos?`+$${bal.toFixed(2)}`:neg?`-$${Math.abs(bal).toFixed(2)}`:"settled up"}
                              </span>
                            </div>
                            <div style={{ marginTop:7, height:4, background:"rgba(255,255,255,0.06)", borderRadius:2, overflow:"hidden" }}>
                              <div style={{ height:"100%", width:`${pct}%`, borderRadius:2, transition:"width 0.5s",
                                background:pos?"linear-gradient(90deg,#4ECDC4,#44B8B0)":neg?"linear-gradient(90deg,#FF6B6B,#FF8E8E)":"transparent" }}/>
                            </div>
                            <div style={{ marginTop:3, fontSize:12, color:"#555" }}>
                              {pos?`gets back $${bal.toFixed(2)}`:neg?`owes $${Math.abs(bal).toFixed(2)}`:"all settled"}
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}

              {/* SETTLE */}
              {tab==="settle" && (
                <div>
                  <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:16 }}>
                    <div>
                      <div style={{ fontWeight:700, color:"#fff" }}>Settlement Plan</div>
                      <div style={{ fontSize:13, color:"#555", marginTop:2 }}>
                        {settle.length} transaction{settle.length!==1?"s":""} needed
                        {simplified && rawDebts.length>simpDebts.length && (
                          <span style={{ color:"#4ECDC4", marginLeft:8, fontWeight:600 }}>saved {rawDebts.length-simpDebts.length}!</span>
                        )}
                      </div>
                    </div>
                    <div style={{ display:"flex", alignItems:"center", gap:8 }}>
                      <span style={{ fontSize:12, color:"#666" }}>Simplify</span>
                      <button className={`toggle${simplified?" on":""}`} onClick={()=>setSimplified(s=>!s)}>
                        <div className="toggle-thumb"/>
                      </button>
                    </div>
                  </div>
                  {!simplified && rawDebts.length>simpDebts.length && (
                    <div style={{ marginBottom:12, padding:"10px 14px", background:"rgba(255,230,109,0.07)", border:"1px solid rgba(255,230,109,0.15)", borderRadius:12, fontSize:13, color:"#FFE66D" }}>
                      üí° Toggle Simplify to cut {rawDebts.length} ‚Üí {simpDebts.length} transactions
                    </div>
                  )}
                  {loading && [1,2].map(i=><div key={i} className="skeleton" style={{ height:64, borderRadius:14, marginBottom:8 }}/>)}
                  {!loading && settle.length===0 && <div style={{ textAlign:"center", color:"#555", padding:"40px 0", fontSize:15 }}>üéâ Everyone is settled up!</div>}
                  <div style={{ display:"flex", flexDirection:"column", gap:10 }}>
                    {settle.map((d,i)=>(
                      <div key={i} className="card" style={{ display:"flex", alignItems:"center", gap:12 }}>
                        <Avatar name={d.from} friends={friends} size={38}/>
                        <div style={{ flex:1 }}>
                          <div style={{ display:"flex", alignItems:"center", gap:8, flexWrap:"wrap" }}>
                            <span style={{ fontWeight:700, color:"#fff" }}>{d.from}</span>
                            <span style={{ color:"#555", fontSize:13 }}>pays</span>
                            <span style={{ fontWeight:800, fontSize:16, color:"#FF6B6B" }}>${d.amount.toFixed(2)}</span>
                            <span style={{ color:"#555", fontSize:13 }}>to</span>
                            <Avatar name={d.to} friends={friends} size={20}/>
                            <span style={{ fontWeight:700, color:"#fff" }}>{d.to}</span>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* AGENDA */}
              {tab==="agenda" && (
                <div>
                  <div style={{ marginBottom:16, padding:"14px 16px", background:"rgba(255,255,255,0.03)", border:"1px solid rgba(255,255,255,0.07)", borderRadius:14 }}>
                    <div className="label">Add Topic</div>
                    <div style={{ display:"flex", flexDirection:"column", gap:10 }}>
                      <input className="input" placeholder="What do we need to discuss?" value={newTopic}
                        onChange={e=>setNewTopic(e.target.value)}
                        onKeyDown={e=>e.key==="Enter"&&!e.shiftKey&&addAgendaItem()}/>
                      <div style={{ display:"flex", gap:10 }}>
                        <select className="input" style={{ flex:1 }} value={addedBy} onChange={e=>setAddedBy(e.target.value)}>
                          <option value="">Added by (optional)</option>
                          {friends.map(f=><option key={f} value={f}>{f}</option>)}
                        </select>
                        <button className="btn btn-primary" style={{ flexShrink:0 }} onClick={addAgendaItem} disabled={saving||!newTopic.trim()}>
                          {saving?<Spinner/>:"Add"}
                        </button>
                      </div>
                    </div>
                  </div>

                  {!loading && agendaItems.length>0 && (
                    <div style={{ display:"flex", gap:8, marginBottom:14 }}>
                      {[["pending","#FF6B6B",pending],["discussed","#4ECDC4",agendaItems.length-pending],["total","#777",agendaItems.length]].map(([label,color,count])=>(
                        <div key={label} style={{ flex:1, padding:"10px 12px", background:`${color}12`, border:`1px solid ${color}25`, borderRadius:12, textAlign:"center" }}>
                          <div style={{ fontSize:20, fontWeight:800, color }}>{count}</div>
                          <div style={{ fontSize:11, color:"#666", marginTop:2 }}>{label}</div>
                        </div>
                      ))}
                    </div>
                  )}

                  {loading && [1,2,3].map(i=><div key={i} className="skeleton" style={{ height:60, borderRadius:13, marginBottom:8 }}/>)}
                  {!loading && agendaItems.length===0 && (
                    <div style={{ textAlign:"center", color:"#555", padding:"60px 0" }}>
                      <div style={{ fontSize:36, marginBottom:10 }}>üìã</div>
                      <div style={{ fontWeight:600, color:"#666" }}>No topics yet</div>
                    </div>
                  )}

                  {[["pending","To Discuss"],["discussed","Discussed ‚úì"]].map(([status, heading])=>{
                    const items = agendaItems.filter(a=>a.status===status);
                    if (!items.length) return null;
                    return (
                      <div key={status} style={{ marginBottom:16 }}>
                        <div style={{ fontSize:11, fontWeight:700, color:status==="pending"?"#888":"#444", textTransform:"uppercase", letterSpacing:"0.07em", marginBottom:8 }}>{heading}</div>
                        <div style={{ display:"flex", flexDirection:"column", gap:8 }}>
                          {items.map(item=>(
                            <div key={item.id} className={`agenda-item${status==="discussed"?" discussed":""}`}>
                              <button className={`agenda-check${status==="discussed"?" on":""}`} onClick={()=>toggleAgenda(item)}>
                                {status==="discussed" && <span style={{ color:"#0f0f1a", fontSize:12, fontWeight:900 }}>‚úì</span>}
                              </button>
                              <div style={{ flex:1, minWidth:0 }}>
                                <div style={{ fontSize:14, fontWeight:500, color:status==="discussed"?"#555":"#e8e8f0", textDecoration:status==="discussed"?"line-through":"none", lineHeight:1.4 }}>{item.topic}</div>
                                {item.added_by && (
                                  <div style={{ display:"flex", alignItems:"center", gap:5, marginTop:4 }}>
                                    <Avatar name={item.added_by} friends={friends} size={14}/>
                                    <span style={{ fontSize:11, color:"#555" }}>Added by {item.added_by}</span>
                                  </div>
                                )}
                              </div>
                              <button className="btn btn-danger" style={{ padding:"4px 8px", fontSize:12, flexShrink:0 }}
                                onClick={()=>deleteAgendaItem(item.id)} disabled={saving}>‚úï</button>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>

          {/* ‚îÄ‚îÄ FAB ‚îÄ‚îÄ */}
          {tab!=="agenda" && (
            <button id="fab" onClick={()=>{ setForm(f=>({...f, splits:Object.fromEntries(friends.map(n=>[n,2]))})); setShowExpense(true); }} disabled={loading||friends.length===0}>+</button>
          )}

          {/* ‚îÄ‚îÄ Bottom nav ‚îÄ‚îÄ */}
          <div id="bottom-nav">
            {TABS.map(t=>(
              <button key={t.id} className={tab===t.id?"active":""} onClick={()=>setTab(t.id)}>
                <span className="icon">{t.icon}</span>
                <span className="label">{t.label}</span>
                {t.id==="agenda" && pending>0 && <span className="badge">{pending}</span>}
              </button>
            ))}
          </div>

          {/* ‚îÄ‚îÄ Add Expense Modal ‚îÄ‚îÄ */}
          {showExpense && (
            <div className="modal-overlay" onClick={e=>e.target===e.currentTarget&&setShowExpense(false)}>
              <div className="modal">
                <h2 style={{ fontFamily:"'Syne',sans-serif", fontWeight:800, fontSize:20, marginBottom:18 }}>Add Expense</h2>
                <div style={{ display:"flex", flexDirection:"column", gap:14 }}>

                  <div>
                    <label className="label">Description</label>
                    <input className="input" placeholder="e.g. Dinner, Uber, Groceries" value={form.description}
                      onChange={e=>setForm(f=>({...f, description:e.target.value}))}/>
                  </div>

                  <div>
                    <label className="label">Amount ($)</label>
                    <input className="input" type="number" inputMode="decimal" placeholder="0.00" min="0" step="0.01"
                      value={form.amount} onChange={e=>setForm(f=>({...f, amount:e.target.value}))}/>
                  </div>

                  <div>
                    <label className="label">Paid by</label>
                    <select className="input" value={form.paid_by} onChange={e=>{
                      const payer = e.target.value;
                      setForm(f=>({ ...f, paid_by:payer, splits:payer?{...f.splits,[payer]:f.splits[payer]||2}:f.splits }));
                    }}>
                      <option value="">Select person</option>
                      {friends.map(f=><option key={f} value={f}>{f}</option>)}
                    </select>
                  </div>

                  <div>
                    <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
                      <span className="label" style={{ margin:0 }}>Split & Servings</span>
                      <div style={{ display:"flex", gap:10 }}>
                        <button style={{ background:"none", border:"none", color:"#888", cursor:"pointer", fontSize:12, fontFamily:"inherit" }}
                          onClick={()=>setForm(f=>({...f, splits:Object.fromEntries(friends.map(n=>[n,2]))}))}>All √ó2</button>
                        <span style={{ color:"#333" }}>¬∑</span>
                        <button style={{ background:"none", border:"none", color:"#888", cursor:"pointer", fontSize:12, fontFamily:"inherit" }}
                          onClick={()=>setForm(f=>({...f, splits:f.paid_by?{[f.paid_by]:f.splits[f.paid_by]||2}:{}}))}>Clear</button>
                      </div>
                    </div>

                    <div style={{ display:"flex", flexDirection:"column", gap:4 }}>
                      {friends.map(name=>{
                        const isPayer = name===form.paid_by;
                        const isIn    = form.splits[name]!==undefined;
                        const srv     = form.splits[name]||2;
                        const col     = getColor(name, friends);
                        const share   = isIn&&formAmt>0&&totalSrv>0 ? (srv/totalSrv)*formAmt : null;
                        return (
                          <div key={name} style={{ display:"flex", alignItems:"center", gap:10, padding:"8px 10px", borderRadius:12,
                            border:`1.5px solid ${isIn?`${col}40`:"transparent"}`,
                            background:isIn?`${col}0d`:"transparent", transition:"all 0.15s" }}>
                            <div onClick={()=>!isPayer&&togglePerson(name)}
                              style={{ display:"flex", alignItems:"center", gap:8, flex:1, cursor:isPayer?"default":"pointer", userSelect:"none" }}>
                              <div style={{ width:22, height:22, borderRadius:6,
                                border:`2px solid ${isIn?col:"#3a3a4a"}`, background:isIn?col:"transparent",
                                display:"flex", alignItems:"center", justifyContent:"center", flexShrink:0 }}>
                                {isPayer
                                  ? <span style={{ color:"#0f0f1a", fontSize:11, fontWeight:900 }}>$</span>
                                  : isIn&&<span style={{ color:"#0f0f1a", fontSize:13, fontWeight:900 }}>‚úì</span>}
                              </div>
                              <Avatar name={name} friends={friends} size={24}/>
                              <span style={{ fontWeight:600, fontSize:14, color:isIn?"#fff":"#555" }}>{name}</span>
                              {isPayer && <span style={{ fontSize:10, color:col, background:`${col}20`, padding:"1px 6px", borderRadius:8, fontWeight:700 }}>payer</span>}
                            </div>
                            {isIn ? (
                              <div style={{ display:"flex", alignItems:"center", gap:8 }}>
                                {share!==null && <span style={{ fontSize:13, fontWeight:700, color:"#aaa", minWidth:48, textAlign:"right" }}>${share.toFixed(2)}</span>}
                                <div className="serving-ctrl">
                                  <button className="serving-btn" onClick={e=>{e.stopPropagation();setServings(name,srv-1);}}>‚àí</button>
                                  <span className="serving-val">{srv}</span>
                                  <button className="serving-btn" onClick={e=>{e.stopPropagation();setServings(name,srv+1);}}>+</button>
                                </div>
                              </div>
                            ) : (
                              <span style={{ fontSize:12, color:"#3a3a4a" }}>tap to add</span>
                            )}
                          </div>
                        );
                      })}
                    </div>

                    {Object.keys(form.splits).length>0 && formAmt>0 && (
                      <div style={{ marginTop:10, padding:"11px 13px", background:"rgba(255,255,255,0.03)", borderRadius:11, border:"1px solid rgba(255,255,255,0.07)" }}>
                        <div style={{ fontSize:10, color:"#555", fontWeight:700, textTransform:"uppercase", letterSpacing:"0.06em", marginBottom:7 }}>Breakdown</div>
                        {Object.entries(form.splits).map(([name,srv])=>{
                          const share = (srv/totalSrv)*formAmt;
                          const col   = getColor(name, friends);
                          return (
                            <div key={name} style={{ display:"flex", justifyContent:"space-between", alignItems:"center", padding:"2px 0" }}>
                              <div style={{ display:"flex", alignItems:"center", gap:6 }}>
                                <Avatar name={name} friends={friends} size={16}/>
                                <span style={{ fontSize:13, color:"#ccc" }}>{name}</span>
                                <span style={{ fontSize:10, color:"#555", background:`${col}18`, padding:"1px 5px", borderRadius:6 }}>√ó{srv}</span>
                              </div>
                              <span style={{ fontSize:13, fontWeight:700, color:"#fff" }}>${share.toFixed(2)}</span>
                            </div>
                          );
                        })}
                        <div style={{ borderTop:"1px solid rgba(255,255,255,0.06)", marginTop:7, paddingTop:7, display:"flex", justifyContent:"space-between" }}>
                          <span style={{ fontSize:11, color:"#555" }}>{totalSrv} servings</span>
                          <span style={{ fontSize:13, fontWeight:800, color:"#FF6B6B" }}>${formAmt.toFixed(2)}</span>
                        </div>
                      </div>
                    )}
                  </div>

                  <div style={{ display:"flex", gap:10 }}>
                    <button className="btn btn-ghost" style={{ flex:1 }}
                      onClick={()=>{ setShowExpense(false); setForm({description:"",amount:"",paid_by:"",splits:{}}); }}>Cancel</button>
                    <button className="btn btn-primary" style={{ flex:2 }} onClick={addExpense} disabled={saving}>
                      {saving?<Spinner/>:"Add Expense"}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* ‚îÄ‚îÄ Add Friend Modal ‚îÄ‚îÄ */}
          {showFriend && (
            <div className="modal-overlay" onClick={e=>e.target===e.currentTarget&&setShowFriend(false)}>
              <div className="modal" style={{ maxWidth:360 }}>
                <h2 style={{ fontFamily:"'Syne',sans-serif", fontWeight:800, fontSize:20, marginBottom:16 }}>Add Friend</h2>
                <input className="input" placeholder="Friend's name" value={newFriend} autoFocus
                  onChange={e=>setNewFriend(e.target.value)}
                  onKeyDown={e=>e.key==="Enter"&&addFriend()}/>
                <div style={{ display:"flex", gap:10, marginTop:14 }}>
                  <button className="btn btn-ghost" style={{ flex:1 }} onClick={()=>setShowFriend(false)}>Cancel</button>
                  <button className="btn btn-primary" style={{ flex:2 }} onClick={addFriend} disabled={saving}>
                    {saving?<Spinner/>:"Add Friend"}
                  </button>
                </div>
              </div>
            </div>
          )}
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
  <style>
    .hide-scroll::-webkit-scrollbar { display: none; }
    .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</body>
</html>
